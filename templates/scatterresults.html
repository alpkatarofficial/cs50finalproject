<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interactive Scatter Plot</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

</head>
<body class="bg-light">
<div class="container py-5">
    <h2 class="text-center text-primary mb-4">Interactive Scatter Plot</h2>

    <div class="mt-4 mb-4 p-3 rounded shadow-sm">
        <h5 class="text-muted">SQL Query Used:</h5>
        <pre style="font-family: 'Poppins', monospace; font-weight: 600; font-size: 1.2rem;" class="bg-light p-3 text-dark">{{ sql_query }}</pre>
    </div>
    <div class="text-end mb-4">
        <button onclick="copySQL()" class="btn btn-outline-primary btn-sm">
            üìã Copy SQL
        </button>
    </div>


    <div class="row mb-4">
        <div class="col-md-6">
            <label for="xSelect" class="form-label">Select X-Axis:</label>
            <select id="xSelect" class="form-select">
                {% for field in fields %}
                    <option value="{{ field }}" {% if field == x_axis %}selected{% endif %}>{{ field|capitalize }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6">
            <label for="ySelect" class="form-label">Select Y-Axis:</label>
            <select id="ySelect" class="form-select">
                {% for field in fields %}
                    <option value="{{ field }}" {% if field == y_axis %}selected{% endif %}>{{ field|capitalize }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div id="scatterPlot" style="height: 600px;"></div>
    <div class="text-center mt-4">
        <a href="/scatterplot" class="btn btn-secondary">‚Üê Back to Plot Filters</a>
    </div>
</div>

<script>
    const fullData = {{ full_data | tojson }};
    const fields = {{ fields | tojson }};
    const xSelect = document.getElementById('xSelect');
    const ySelect = document.getElementById('ySelect');

    function updatePlot() {
        const xField = xSelect.value;
        const yField = ySelect.value;

        const xValues = [], yValues = [];
        fullData.forEach(row => {
            if (row[xField] != null && row[yField] != null) {
                xValues.push(row[xField]);
                yValues.push(row[yField]);
            }
        });

        const { slope, intercept } = linearRegression(xValues, yValues);
        const fitX = [Math.min(...xValues), Math.max(...xValues)];
        const fitY = fitX.map(x => slope * x + intercept);

        const scatterTrace = {
            x: xValues,
            y: yValues,
            mode: 'markers',
            type: 'scatter',
            name: 'Data Points',
            marker: {
                size: 8,
                color: 'rgba(33, 150, 243, 0.7)',
                line: { width: 1 }
            }
        };

        const trendlineTrace = {
            x: fitX,
            y: fitY,
            mode: 'lines',
            type: 'scatter',
            name: 'Best Fit Line',
            line: {
                dash: 'dash',
                width: 2,
                color: 'rgba(255, 99, 71, 1)'
            }
        };

        const layout = {
            xaxis: { title: xField.charAt(0).toUpperCase() + xField.slice(1) },
            yaxis: { title: yField.charAt(0).toUpperCase() + yField.slice(1) },
            margin: { t: 20 },
            legend: { x: 0, y: 1.1, orientation: 'h' }
        };

        Plotly.newPlot('scatterPlot', [scatterTrace, trendlineTrace], layout);
    }

    function linearRegression(x, y) {
        const n = x.length;
        const xMean = x.reduce((a, b) => a + b, 0) / n;
        const yMean = y.reduce((a, b) => a + b, 0) / n;
        let num = 0, den = 0;
        for (let i = 0; i < n; i++) {
            num += (x[i] - xMean) * (y[i] - yMean);
            den += (x[i] - xMean) ** 2;
        }
        const slope = num / den;
        const intercept = yMean - slope * xMean;
        return { slope, intercept };
    }

    xSelect.addEventListener('change', updatePlot);
    ySelect.addEventListener('change', updatePlot);

    updatePlot();
</script>
<script>
function copySQL() {
    const sqlBlock = document.querySelector('pre');
    navigator.clipboard.writeText(sqlBlock.innerText)
}
</script>

</body>
</html>
